---
import { HolyGrailLayout } from '@layouts/HolyGrailLayout';
import { Button } from '@components/Button';
import { GET } from './api/v1/auth/verify-user';
import { Link } from '../components/Link';
import { InputWithLabel } from '../components/Form/InputWithLabel';

export const prerender = false;

const res = await (await GET(Astro)).json();
// if (res.user) {
//   return Astro.redirect('/');
// }

const { searchParams } = new URL(Astro.request.url);
// const searchParamsKeys = searchParams.entries();
let authorizationFailed: boolean = false;
const authorizationFailedParam = searchParams.get('authorizationFailed');
if (authorizationFailedParam === '' || authorizationFailedParam === 'true') {
  authorizationFailed = true;
}

const redirectTo = searchParams.get('redirectTo');
---

<HolyGrailLayout
  title='Login'
  seoProps={{
    title: 'Login',
    description:
      "Login into your DuckyCoding's blog account: manage your favorite posts!",
    extend: {
      meta: [
        {
          name: 'keywords',
          content: 'login, DuckyCoding, web development, auth',
        },
      ],
    },
  }}
>
  <h1 class='mb-8 text-center text-4xl font-extrabold'>Login</h1>
  <p class='mb-8 text-center text-lg'>
    Access your account to manage your favorite posts and customize your
    experience!
  </p>
  {
    authorizationFailed && (
      <>
        <p class='text-center text-red-500'>
          You've been redirected here because your session might have expired or
          your access credentials have been changed from another device.
        </p>
        <p class='text-center text-red-500'>Please login again.</p>
      </>
    )
  }
  <form
    action={`/api/v1/auth/login${redirectTo ? `?redirectTo=${redirectTo}` : ''}`}
    method='post'
    class='flex flex-col gap-4'
  >
    <InputWithLabel
      type='text'
      name='username'
      id='username'
      title='Username'
      placeholder='Your username'
    >
      Username
    </InputWithLabel>
    <InputWithLabel
      type='password'
      name='password'
      id='password'
      title='Password'
      placeholder='Your password'
    >
      Password
    </InputWithLabel>

    <Button class={'w-full mt-4'} type='submit' variant={'contained'}
      >Login</Button
    >
  </form>

  <p class='mt-8 text-center'>
    Don't have an account?
    <Link href='/signup' class={'font-extrabold'}> Sign up now! </Link>
  </p>
</HolyGrailLayout>

<script>
  // if this script is executed, it means the user is not logged in
  // so we can safely clear the local storage from user related data
  window.localStorage.removeItem('user');
  window.localStorage.removeItem('sessionExpiresAt');
</script>
