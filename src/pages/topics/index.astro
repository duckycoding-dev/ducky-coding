---
import TopicCard from '@components/Card/TopicCard.astro';
import HolyGrailLayout from '@layouts/HolyGrailLayout/HolyGrailLayout.astro';
import { TopicsService } from '@db/features/topics/topics.service';
import type { ImageMetadata } from 'astro';
import { matchImageFromGlobImport } from '@utils/images/images';
import DuckyCodingLogo from '@assets/images/DuckyCoding_logo.png';
import { serverLogger } from '@utils/logs/logger';

const topicsWithImages = await TopicsService.getAllTopicsWithImage();
// Process topics and match with images
const processedTopics = await Promise.all(
  topicsWithImages.map(async (topic) => {
    let processedImage: ImageMetadata | undefined;
    const imageToFindPath = topic.image?.path;
    if (imageToFindPath) {
      const images = import.meta.glob<{ default: ImageMetadata }>(
        `/src/assets/images/topics/**/*.{jpeg,jpg,png,gif,webp,svg}`,
      );
      processedImage = await matchImageFromGlobImport(
        images,
        imageToFindPath,
        serverLogger,
      );
    }

    const processedTopic = {
      ...topic,
      imageSrc: processedImage ?? null,
    };
    return processedTopic;
  }),
);
---

<HolyGrailLayout
  title='Topics'
  seoProps={{
    title: 'Topics',
    description:
      "Here's a list of all the topics I've written about in my posts: find what you need in a nicely organized way.",
    extend: {
      meta: [
        {
          name: 'keywords',
          content: 'DuckyCoding, web development, topics, posts',
        },
      ],
    },
  }}
>
  <h1
    class='decoration-accent mb-8 text-center text-4xl font-extrabold underline underline-offset-4'
  >
    Topics
  </h1>
  <section
    class='xs:grid-cols-2 grid grid-cols-1 gap-5 sm:grid-cols-[repeat(auto-fill,minmax(150px,1fr))]'
  >
    {
      processedTopics.length === 0 && (
        <p class='col-span-full text-center text-lg font-semibold'>
          No topics available at the moment.
        </p>
      )
    }
    {
      processedTopics.map((topic, index) => (
        <TopicCard
          imageSrc={topic.imageSrc || DuckyCodingLogo}
          imageAlt={topic.image?.alt ?? `${topic.title} representation`}
          title={topic.title}
          slug={topic.slug}
          backgroundGradient={topic.backgroundGradient || undefined}
          loading={index < 4 ? 'eager' : 'lazy'}
        />
      ))
    }
  </section>
</HolyGrailLayout>
