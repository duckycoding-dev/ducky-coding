---
import HolyGrailLayout from '@layouts/HolyGrailLayout/HolyGrailLayout.astro';
import { TopicsService } from '@db/features/topics/topics.service';
import PostCard from '@components/PostCard/PostCard.astro';
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import { type ImageMetadata } from 'astro';
import { matchImageFromGlobImport } from '@utils/images/images';
import { IMAGE_DENSITIES } from '@utils/globals';
import { serverLogger } from '@utils/logs/logger';

// 1. Generate a new path for every collection entry
export async function getStaticPaths() {
  const topicsWithImages = await TopicsService.getAllTopicsWithImage();
  // Process topics and match with images

  const dynamicRouteData = await Promise.all(
    topicsWithImages.map(async (topic) => {
      let processedImage: ImageMetadata | undefined;
      const imageToFindPath = topic.image?.path;
      if (imageToFindPath) {
        const images = import.meta.glob<{ default: ImageMetadata }>(
          `/src/assets/images/topics/**/*.{jpeg,jpg,png,gif,webp,svg}`,
        );
        processedImage = await matchImageFromGlobImport(
          images,
          imageToFindPath,
        );
      }

      const processedTopic = {
        ...topic,
        imageSrc: processedImage ?? null,
      };
      return {
        params: { topic: decodeURI(topic.slug) },
        props: { processedTopic },
      };
    }),
  );

  return dynamicRouteData;
}
// 2. For your template, you can get the entry directly from the prop
const { processedTopic } = Astro.props;
const postsEntries = await getCollection('posts');

const filteredRelatedPosts = postsEntries.filter((entry) => {
  return (
    entry.data.topicTitle === processedTopic.title &&
    entry.data.status === 'published'
  );
});

const processedPosts = await Promise.all(
  filteredRelatedPosts.map(async (post) => {
    let processedImage: ImageMetadata | undefined;
    const imageToFindPath = `${post.data.bannerImagePath}`;
    if (imageToFindPath) {
      const images = import.meta.glob<{ default: ImageMetadata }>(
        `/src/assets/images/posts/**/*.{jpeg,jpg,png,gif,webp,svg}`,
      );
      processedImage = await matchImageFromGlobImport(
        images,
        imageToFindPath,
        serverLogger,
      );
    }

    const processedPost = {
      ...post,
      processedBannerImage: processedImage ?? null,
    };
    return processedPost;
  }),
);
---

<HolyGrailLayout
  title={processedTopic.title}
  seoProps={{
    title: `Topic: ${processedTopic.title}`,
    description: `Discover the latest posts related to ${processedTopic.title}, written by DuckyCoding!`,
    extend: {
      meta: [
        {
          name: 'keywords',
          content: `${processedTopic.title}, posts about ${processedTopic.title}, posts`,
        },
      ],
    },
  }}
>
  <section
    class='bg-accent2 shadow-comic relative grid h-[25dvh] grid-cols-1 grid-rows-1 flex-col place-items-center gap-4 overflow-hidden border-4 md:h-[35dvh]'
  >
    <h1
      class='bg-primary-700 border-secondary shadow-comic text-8 z-1 [grid-column:1/1] [grid-row:1/1] border-4 px-6 text-center text-[clamp(0.75rem,10vw,6rem)] font-extrabold md:text-left [@media(max-height:425px)]:text-[clamp(0.75rem,10vw,4.5rem)]'
    >
      {processedTopic.title}
    </h1>
    {
      processedTopic.imageSrc ? (
        <Image
          class='[grid-column:1/1] [grid-row:1/1] h-[150%] w-min object-cover md:mx-0 md:h-[200%]'
          src={processedTopic.imageSrc}
          alt={
            processedTopic.image?.alt ??
            `${processedTopic.title} representation`
          }
          densities={IMAGE_DENSITIES}
        />
      ) : null
    }
  </section>
  {
    processedPosts.length > 0 ? (
      <ul class='grid-container mt-8 grid gap-8'>
        {processedPosts.map((post) => {
          return (
            <li class='mb-8 last-of-type:mb-0 md:last-of-type:mb-8'>
              <PostCard
                class='block h-full'
                post={post}
                bannerImage={
                  post?.processedBannerImage || processedTopic.imageSrc || null
                }
              />
            </li>
          );
        })}
      </ul>
    ) : (
      <>
        <h2 class='mt-8 text-center text-2xl font-extrabold text-balance md:text-left'>
          {`There isn't any content about ${processedTopic.title} yet :'(`}
        </h2>
        <h3 class='text-center text-xl font-extrabold md:text-left'>
          Please check again soon!
        </h3>
      </>
    )
  }
</HolyGrailLayout>

<style>
  @media (width >= 768px) {
    .grid-container {
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    }
  }
</style>
